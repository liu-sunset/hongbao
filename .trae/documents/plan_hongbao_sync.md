# 计划：实现多端实时同步与红包发送限制

为了解决“多设备数据不同步”和“限制红包发送”的问题，我们需要将数据存储从本地的 `localStorage` 迁移到云端数据库。

考虑到项目目前的轻量级特性（单 HTML 文件），建议引入 **BaaS (Backend as a Service)** 服务，无需单独部署后端服务器即可实现数据云端存储和实时同步。本计划将使用 **LeanCloud**（或者兼容的云服务）来实现。

## 1. 核心变更分析

### 1.1 数据存储迁移

* **当前**：数据存储在浏览器 `localStorage`，仅当前设备可见。

* **目标**：数据存储在云端数据库，所有设备共享同一份数据。

### 1.2 实时性 (Real-time)

* 引入 **LiveQuery** 或 **WebSocket** 机制。

* 当管理员发红包或有人抢红包时，所有在线用户的页面自动刷新，无需手动刷新。

### 1.3 业务逻辑调整

* **发送限制**：在发送前查询云端，如果存在 `remaining > 0` 的红包，则禁止发送新红包。

* **抢红包并发**：使用云端原子操作（Atomic Operation）处理抢红包请求，防止“超发”或数据冲突。

## 2. 实施步骤

### 阶段一：引入云端 SDK 与配置

1. 在 `index.html` 中引入 LeanCloud 前端 SDK (CDN 方式)。
2. 初始化 LeanCloud 应用（需要配置 App ID 和 App Key）。

   * *注：需要您注册 LeanCloud 账号并创建一个开发版应用（免费），获取 App ID 和 App Key。*

### 阶段二：重构数据层 (Data Layer)

1. **查询状态 (`init`)**：

   * 页面加载时，从云端查询最新的一条红包记录。

   * 替换原有的 `localStorage` 读取逻辑。
2. **发送红包 (`send`)**：

   * **前置检查**：查询云端是否存在 `count > 0` 的未过期红包。

   * **限制逻辑**：如果存在，弹窗提示“当前红包未抢完，无法发送新红包”。

   * **创建记录**：如果不存在，在云端创建一条新的红包记录。
3. **抢红包 (`grab`)**：

   * 将抢红包逻辑改为异步请求。

   * 使用云端原子操作减少 `remaining` 计数，并更新参与者列表。

   * 处理并发冲突（如两人同时抢最后一个红包的情况）。

### 阶段三：实现实时同步

1. 使用 LiveQuery 订阅红包对象的变化。
2. 当云端数据发生变化（创建、更新）时，自动触发本地 `render()` 函数更新 UI。

### 阶段四：UI 适配与清理

1. 添加“加载中”状态提示（因为云端请求是异步的，会有短暂延迟）。
2. 清理不再需要的 `localStorage` 代码。

## 3. 用户需配合事项

为了代码能正常运行，您需要：

1. 访问 LeanCloud (或类似服务商) 官网注册账号。
2. 创建一个新应用。
3. 在代码中填入您的 **App ID** 和 **App Key**。

（如果您不想注册账号，我可以提供一个临时的测试配置，但为了长期使用，建议您拥有自己的配置）

## 4. 验证计划

1. **管理员测试**：发送红包，刷新页面，确认状态保留。
2. **多端测试**：用电脑发红包，用手机访问网页，确认能立刻看到红包。
3. **限制测试**：在未抢完的情况下尝试再次发送，确认被拦截。
4. **并发测试**：模拟多人同时抢红包，确认数据准确。

